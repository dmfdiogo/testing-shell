name: Push to OCI Object Storage

on:
  push:
  workflow_dispatch:

jobs:
  push-to-bucket:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Download OCI CLI install script
        run: curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh -o install.sh

      - name: Run OCI CLI install script
        run: bash install.sh --accept-all-defaults --install-dir /home/runner/oci

      - name: Add OCI CLI to PATH
        run: echo "/home/runner/oci/bin" >> $GITHUB_PATH
      
      - name: Configure OCI credentials
        env:
          OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
          OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
          OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}
          OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
          OCI_CLI_KEY_BASE64: ${{ secrets.OCI_CLI_KEY_BASE64 }}
        run: |
          # Create directory with proper permissions
          mkdir -p /home/runner/.oci
          chmod 700 /home/runner/.oci
          
          # Debug output
          echo "Creating key file in: /home/runner/.oci"
          
          # Decode and save key
          echo "$OCI_CLI_KEY_BASE64" | base64 -d > /home/runner/.oci/oci_api_key.pem
          chmod 600 /home/runner/.oci/oci_api_key.pem
          
          # Create config
          cat > /home/runner/.oci/config << EOF
          [DEFAULT]
          user=${OCI_CLI_USER}
          fingerprint=${OCI_CLI_FINGERPRINT}
          tenancy=${OCI_CLI_TENANCY}
          region=${OCI_CLI_REGION}
          key_file=/home/runner/.oci/oci_api_key.pem
          EOF
          chmod 600 /home/runner/.oci/config

      - name: Copy files to OCI bucket
        env:
          BUCKET_NAME: ${{ secrets.OCI_BUCKET_NAME }}
          NAMESPACE: ${{ secrets.OCI_NAMESPACE }}
        run: |
          oci os object bulk-upload \
            --namespace ${NAMESPACE} \
            --bucket-name ${BUCKET_NAME} \
            --src-dir . \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --no-follow-symlinks

